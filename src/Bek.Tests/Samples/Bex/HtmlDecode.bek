//helpers
function D1(c) = ite(('0' <= c) && (c <= '9'), c -'0', 10 + ite(('A' <= c) && (c <= 'F'), c -'A', c - 'a'));
function D2(b,x0,x1) = (b*D1(x0) + D1(x1));
function D3(b,x0,x1,x2) = (b*D2(b,x0,x1) + D1(x2));
function D4(b,x0,x1,x2,x3) = (b*D3(b,x0,x1,x2) + D1(x3));
function D5(b,x0,x1,x2,x3,x4) = (b*D4(b,x0,x1,x2,x3) + D1(x4));

program HtmlDecode(_){ 
  replace {
    //most common cases should come first for efficiency
    "[^&]" ==> [#0];
    "&amp;"  ==> "&";
    "&lt;"   ==> "<";
    "&gt;"   ==> ">";
    "&quot;" ==> "\"";
    "&apos;" ==> "\'";
    //exceptions, do not rewrite 0
    "&#0;" ==> "&#0;";
    "&#00;" ==> "&#00;";
    "&#000;" ==> "&#000;";
    "&#0000;" ==> "&#0000;";
    "&#00000;" ==> "&#00000;";
    "&#x0;" ==> "&#x0;";
    "&#x00;" ==> "&#x00;";
    "&#x000;" ==> "&#x000;";
    "&#x0000;" ==> "&#x0000;";
    "&#X0;" ==> "&#X0;";
    "&#X00;" ==> "&#X00;";
    "&#X000;" ==> "&#X000;";
    "&#X0000;" ==> "&#X0000;";
    //decimal encodings
    "&#[0-9];"             ==> [D1(#2)];
    "&#[0-9][0-9];"        ==> [D2(10,#2,#3)];
    "&#[0-9][0-9][0-9];"   ==> [D3(10,#2,#3,#4)];
    "&#[0-9]{4};"          ==> [D4(10,#2,#3,#4,#5)];
    "&#[0-5][0-9]{4};"     ==> [D5(10,#2,#3,#4,#5,#6)];
    "&#6[0-4][0-9]{3};"    ==> [D5(10,#2,#3,#4,#5,#6)];
    "&#65[0-4][0-9]{2};"   ==> [D5(10,#2,#3,#4,#5,#6)];
    "&#655[0-2][0-9];"     ==> [D5(10,#2,#3,#4,#5,#6)];
    "&#6553[0-5];"         ==> [D5(10,#2,#3,#4,#5,#6)];
    //hexadecimal encodings
    "&#[xX][0-9A-Fa-f]{1};"==> [D1(#3)];
    "&#[xX][0-9A-Fa-f]{2};"==> [D2(16,#3,#4)];
    "&#[xX][0-9A-Fa-f]{3};"==> [D3(16,#3,#4,#5)];
    "&#[xX][0-9A-Fa-f]{4};"==> [D4(16,#3,#4,#5,#6)];
    //other, less common fixed patterns
    "&nbsp;" ==> ['\xA0'];
    "&iexcl;" ==> ['\xA1'];
    "&cent;" ==> ['\xA2'];
    "&pound;" ==> ['\xA3'];
    "&curren;" ==> ['\xA4'];
    "&yen;" ==> ['\xA5'];
    "&brvbar;" ==> ['\xA6'];
    "&sect;" ==> ['\xA7'];
    "&uml;" ==> ['\xA8'];
    "&copy;" ==> ['\xA9'];
    "&ordf;" ==> ['\xAA'];
    "&laquo;" ==> ['\xAB'];
    "&not;" ==> ['\xAC'];
    "&shy;" ==> ['\xAD'];
    "&reg;" ==> ['\xAE'];
    "&macr;" ==> ['\xAF'];
    "&deg;" ==> ['\xB0'];
    "&plusmn;" ==> ['\xB1'];
    "&sup2;" ==> ['\xB2'];
    "&sup3;" ==> ['\xB3'];
    "&acute;" ==> ['\xB4'];
    "&micro;" ==> ['\xB5'];
    "&para;" ==> ['\xB6'];
    "&middot;" ==> ['\xB7'];
    "&cedil;" ==> ['\xB8'];
    "&sup1;" ==> ['\xB9'];
    "&ordm;" ==> ['\xBA'];
    "&raquo;" ==> ['\xBB'];
    "&frac14;" ==> ['\xBC'];
    "&frac12;" ==> ['\xBD'];
    "&frac34;" ==> ['\xBE'];
    "&iquest;" ==> ['\xBF'];
    "&times;" ==> ['\xD7'];
    "&divide;" ==> ['\xF7'];
    "&Agrave;" ==> ['\xC0'];
    "&Aacute;" ==> ['\xC1'];
    "&Acirc;" ==> ['\xC2'];
    "&Atilde;" ==> ['\xC3'];
    "&Auml;" ==> ['\xC4'];
    "&Aring;" ==> ['\xC5'];
    "&AElig;" ==> ['\xC6'];
    "&Ccedil;" ==> ['\xC7'];
    "&Egrave;" ==> ['\xC8'];
    "&Eacute;" ==> ['\xC9'];
    "&Ecirc;" ==> ['\xCA'];
    "&Euml;" ==> ['\xCB'];
    "&Igrave;" ==> ['\xCC'];
    "&Iacute;" ==> ['\xCD'];
    "&Icirc;" ==> ['\xCE'];
    "&Iuml;" ==> ['\xCF'];
    "&ETH;" ==> ['\xD0'];
    "&Ntilde;" ==> ['\xD1'];
    "&Ograve;" ==> ['\xD2'];
    "&Oacute;" ==> ['\xD3'];
    "&Ocirc;" ==> ['\xD4'];
    "&Otilde;" ==> ['\xD5'];
    "&Ouml;" ==> ['\xD6'];
    "&Oslash;" ==> ['\xD8'];
    "&Ugrave;" ==> ['\xD9'];
    "&Uacute;" ==> ['\xDA'];
    "&Ucirc;" ==> ['\xDB'];
    "&Uuml;" ==> ['\xDC'];
    "&Yacute;" ==> ['\xDD'];
    "&THORN;" ==> ['\xDE'];
    "&szlig;" ==> ['\xDF'];
    "&agrave;" ==> ['\xE0'];
    "&aacute;" ==> ['\xE1'];
    "&acirc;" ==> ['\xE2'];
    "&atilde;" ==> ['\xE3'];
    "&auml;" ==> ['\xE4'];
    "&aring;" ==> ['\xE5'];
    "&aelig;" ==> ['\xE6'];
    "&ccedil;" ==> ['\xE7'];
    "&egrave;" ==> ['\xE8'];
    "&eacute;" ==> ['\xE9'];
    "&ecirc;" ==> ['\xEA'];
    "&euml;" ==> ['\xEB'];
    "&igrave;" ==> ['\xEC'];
    "&iacute;" ==> ['\xED'];
    "&icirc;" ==> ['\xEE'];
    "&iuml;" ==> ['\xEF'];
    "&eth;" ==> ['\xF0'];
    "&ntilde;" ==> ['\xF1'];
    "&ograve;" ==> ['\xF2'];
    "&oacute;" ==> ['\xF3'];
    "&ocirc;" ==> ['\xF4'];
    "&otilde;" ==> ['\xF5'];
    "&ouml;" ==> ['\xF6'];
    "&oslash;" ==> ['\xF8'];
    "&ugrave;" ==> ['\xF9'];
    "&uacute;" ==> ['\xFA'];
    "&ucirc;" ==> ['\xFB'];
    "&uuml;" ==> ['\xFC'];
    "&yacute;" ==> ['\xFD'];
    "&thorn;" ==> ['\xFE'];
    "&yuml;" ==> ['\xFF'];
    "&OElig;" ==> ['\u0152'];
    "&oelig;" ==> ['\u0153'];
    "&Scaron;" ==> ['\u0160'];
    "&scaron;" ==> ['\u0161'];
    "&Yuml;" ==> ['\u0178'];
    "&fnof;" ==> ['\u0192'];
    "&circ;" ==> ['\u02C6'];
    "&tilde;" ==> ['\u02DC'];
    "&Alpha;" ==> ['\u0391'];
    "&Beta;" ==> ['\u0392'];
    "&Gamma;" ==> ['\u0393'];
    "&Delta;" ==> ['\u0394'];
    "&Epsilon;" ==> ['\u0395'];
    "&Zeta;" ==> ['\u0396'];
    "&Eta;" ==> ['\u0397'];
    "&Theta;" ==> ['\u0398'];
    "&Iota;" ==> ['\u0399'];
    "&Kappa;" ==> ['\u039A'];
    "&Lambda;" ==> ['\u039B'];
    "&Mu;" ==> ['\u039C'];
    "&Nu;" ==> ['\u039D'];
    "&Xi;" ==> ['\u039E'];
    "&Omicron;" ==> ['\u039F'];
    "&Pi;" ==> ['\u03A0'];
    "&Rho;" ==> ['\u03A1'];
    "&Sigma;" ==> ['\u03A3'];
    "&Tau;" ==> ['\u03A4'];
    "&Upsilon;" ==> ['\u03A5'];
    "&Phi;" ==> ['\u03A6'];
    "&Chi;" ==> ['\u03A7'];
    "&Psi;" ==> ['\u03A8'];
    "&Omega;" ==> ['\u03A9'];
    "&alpha;" ==> ['\u03B1'];
    "&beta;" ==> ['\u03B2'];
    "&gamma;" ==> ['\u03B3'];
    "&delta;" ==> ['\u03B4'];
    "&epsilon;" ==> ['\u03B5'];
    "&zeta;" ==> ['\u03B6'];
    "&theta;" ==> ['\u03B8'];
    "&iota;" ==> ['\u03B9'];
    "&kappa;" ==> ['\u03BA'];
    "&lambda;" ==> ['\u03BB'];
    "&mu;" ==> ['\u03BC'];
    "&nu;" ==> ['\u03BD'];
    "&xi;" ==> ['\u03BE'];
    "&omicron;" ==> ['\u03BF'];
    "&pi;" ==> ['\u03C0'];
    "&rho;" ==> ['\u03C1'];
    "&sigmaf;" ==> ['\u03C2'];
    "&sigma;" ==> ['\u03C3'];
    "&tau;" ==> ['\u03C4'];
    "&upsilon;" ==> ['\u03C5'];
    "&phi;" ==> ['\u03C6'];
    "&chi;" ==> ['\u03C7'];
    "&psi;" ==> ['\u03C8'];
    "&omega;" ==> ['\u03C9'];
    "&thetasym;" ==> ['\u03D1'];
    "&upsih;" ==> ['\u03D2'];
    "&piv;" ==> ['\u03D6'];
    "&ensp;" ==> ['\u2002'];
    "&emsp;" ==> ['\u2003'];
    "&thinsp;" ==> ['\u2009'];
    "&zwnj;" ==> ['\u200C'];
    "&zwj;" ==> ['\u200D'];
    "&lrm;" ==> ['\u200E'];
    "&rlm;" ==> ['\u200F'];
    "&ndash;" ==> ['\u2013'];
    "&mdash;" ==> ['\u2014'];
    "&lsquo;" ==> ['\u2018'];
    "&rsquo;" ==> ['\u2019'];
    "&sbquo;" ==> ['\u201A'];
    "&ldquo;" ==> ['\u201C'];
    "&rdquo;" ==> ['\u201D'];
    "&bdquo;" ==> ['\u201E'];
    "&dagger;" ==> ['\u2020'];
    "&Dagger;" ==> ['\u2021'];
    "&bull;" ==> ['\u2022'];
    "&hellip;" ==> ['\u2026'];
    "&permil;" ==> ['\u2030'];
    "&prime;" ==> ['\u2032'];
    "&Prime;" ==> ['\u2033'];
    "&lsaquo;" ==> ['\u2039'];
    "&rsaquo;" ==> ['\u203A'];
    "&oline;" ==> ['\u203E'];
    "&frasl;" ==> ['\u2044'];
    "&euro;" ==> ['\u20AC'];
    "&image;" ==> ['\u2111'];
    "&weierp;" ==> ['\u2118'];
    "&real;" ==> ['\u211C'];
    "&trade;" ==> ['\u2122'];
    "&alefsym;" ==> ['\u2135'];
    "&larr;" ==> ['\u2190'];
    "&uarr;" ==> ['\u2191'];
    "&rarr;" ==> ['\u2192'];
    "&darr;" ==> ['\u2193'];
    "&harr;" ==> ['\u2194'];
    "&crarr;" ==> ['\u21B5'];
    "&lArr;" ==> ['\u21D0'];
    "&uArr;" ==> ['\u21D1'];
    "&rArr;" ==> ['\u21D2'];
    "&dArr;" ==> ['\u21D3'];
    "&hArr;" ==> ['\u21D4'];
    "&forall;" ==> ['\u2200'];
    "&part;" ==> ['\u2202'];
    "&exist;" ==> ['\u2203'];
    "&empty;" ==> ['\u2205'];
    "&nabla;" ==> ['\u2207'];
    "&isin;" ==> ['\u2208'];
    "&notin;" ==> ['\u2209'];
    "&ni;" ==> ['\u220B'];
    "&prod;" ==> ['\u220F'];
    "&sum;" ==> ['\u2211'];
    "&minus;" ==> ['\u2212'];
    "&lowast;" ==> ['\u2217'];
    "&radic;" ==> ['\u221A'];
    "&prop;" ==> ['\u221D'];
    "&infin;" ==> ['\u221E'];
    "&ang;" ==> ['\u2220'];
    "&and;" ==> ['\u2227'];
    "&or;" ==> ['\u2228'];
    "&cap;" ==> ['\u2229'];
    "&cup;" ==> ['\u222A'];
    "&int;" ==> ['\u222B'];
    "&there4;" ==> ['\u2234'];
    "&sim;" ==> ['\u223C'];
    "&cong;" ==> ['\u2245'];
    "&asymp;" ==> ['\u2248'];
    "&ne;" ==> ['\u2260'];
    "&equiv;" ==> ['\u2261'];
    "&le;" ==> ['\u2264'];
    "&ge;" ==> ['\u2265'];
    "&sub;" ==> ['\u2282'];
    "&sup;" ==> ['\u2283'];
    "&nsub;" ==> ['\u2284'];
    "&sube;" ==> ['\u2286'];
    "&supe;" ==> ['\u2287'];
    "&oplus;" ==> ['\u2295'];
    "&otimes;" ==> ['\u2297'];
    "&perp;" ==> ['\u22A5'];
    "&sdot;" ==> ['\u22C5'];
    "&lceil;" ==> ['\u2308'];
    "&rceil;" ==> ['\u2309'];
    "&lfloor;" ==> ['\u230A'];
    "&rfloor;" ==> ['\u230B'];
    "&lang;" ==> ['\u2329'];
    "&rang;" ==> ['\u232A'];
    "&loz;" ==> ['\u25CA'];
    "&spades;" ==> ['\u2660'];
    "&clubs;" ==> ['\u2663'];
    "&hearts;" ==> ['\u2665'];
    "&diams;" ==> ['\u2666'];
    else ==> [#0];
  };
}
